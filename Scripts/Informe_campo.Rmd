---
title: "Análisis Bases de dato campo C. citri"
author: "Madeleyne Parra Fuente"
date: "25/3/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "D:/OneDrive - AGROSAVIA - CORPORACION COLOMBIANA DE INVESTIGACION AGROPECUARIA/R_scripts/D_citri_Madeleyne_2021_03_24/")
```

## 1. Librerías
```{r librerias}
#libraries----
library(dplyr)
library(ggplot2)
library(car)
library(agricolae)
library(officer)
library(rvg)
```
# 2. Lectura de los datos

Se realiza la lectura de los datos

```{r data_reading}
#Readin Data base----
#Field data base
db_D_citri_field<- read.csv2("./Data/BD Dinámica Poblacional -D. citri Caribia_Campo_Actualizada_21_12_2020 (1).csv", encoding = "UTF-8")

```

# 3. Limpieza de los datos

Se realiza la eliminación de las columnas que no tienen relevancia para el análisis. Solo quedarían "MES", "CULTIVAR", "VARIEDAD", "PORTAINJERTO", "REPETICION", "PUNTO", "BROTES", "BDcitri". Se realiza el formateo de la variable brotes, los datos ausentes se eliminan y se definenen los factores

```{r data_cleaning}
#No important columns are deleted
db_D_citri_field<- db_D_citri_field[c("MES", "CULTIVAR", "VARIEDAD", "PORTAINJERTO", "REPETICION", 
                                       "PUNTO", "BROTES", "BDcitri")]
#"BROTES" variable is reformated 
db_D_citri_field$BROTES<- as.integer(db_D_citri_field$BROTES)
#Percentages of buds infested are calculated
db_D_citri_field$`Brotes afectados (%)`<- round((db_D_citri_field$BDcitri/db_D_citri_field$BROTES)*100, digits = 0)
#Missing data is not taking into account
db_D_citri_field<- db_D_citri_field[!is.na(db_D_citri_field$`Brotes afectados (%)`),]
#Set factors
#11 levels in "MES" factor. 4th month is not present
db_D_citri_field$MES<- as.factor(db_D_citri_field$MES)
#3 levels: Naranja mandarina y limón 
db_D_citri_field$CULTIVAR<- as.factor(db_D_citri_field$CULTIVAR)
#16 varieties
db_D_citri_field$VARIEDAD<- as.factor(db_D_citri_field$VARIEDAD)
#2 Rootstocks
db_D_citri_field$PORTAINJERTO<- as.factor(db_D_citri_field$PORTAINJERTO)
#4 Cardinal points
db_D_citri_field$PUNTO<- as.factor(db_D_citri_field$PUNTO)
```

## 4. Estadísiticos descriptivos

Promedios, desviación estandar e histogramas de niveles unidos

```{r descriptive_statistics}
#Descriptive statistics----
#Observations and distribution 
summary(db_D_citri_field)
#summary statistics byb factors
#MES
with(db_D_citri_field, tapply(`Brotes afectados (%)`, MES, function(x) {
  sprintf("M (SD) = %1.2f (%1.2f)", mean(x), sd(x))
}))
ggplot(db_D_citri_field, aes(`Brotes afectados (%)`, fill = MES)) +
  geom_histogram(binwidth=20, position="dodge")
#CULTIVAR
with(db_D_citri_field, tapply(`Brotes afectados (%)`, CULTIVAR, function(x) {
  sprintf("M (SD) = %1.2f (%1.2f)", mean(x), sd(x))
}))
ggplot(db_D_citri_field, aes(`Brotes afectados (%)`, fill = CULTIVAR)) +
  geom_histogram(binwidth=20, position="dodge")
#VARIEDAD
with(db_D_citri_field, tapply(`Brotes afectados (%)`, VARIEDAD, function(x) {
  sprintf("M (SD) = %1.2f (%1.2f)", mean(x), sd(x))
}))
ggplot(db_D_citri_field, aes(`Brotes afectados (%)`, fill = VARIEDAD)) +
  geom_histogram(binwidth=20, position="dodge")
#PORTAINJERTO
with(db_D_citri_field, tapply(`Brotes afectados (%)`, PORTAINJERTO, function(x) {
  sprintf("M (SD) = %1.2f (%1.2f)", mean(x), sd(x))
}))
ggplot(db_D_citri_field, aes(`Brotes afectados (%)`, fill = PORTAINJERTO)) +
  geom_histogram(binwidth=20, position="dodge")
#PUNTO
with(db_D_citri_field, tapply(`Brotes afectados (%)`, PUNTO, function(x) {
  sprintf("M (SD) = %1.2f (%1.2f)", mean(x), sd(x))
}))
ggplot(db_D_citri_field, aes(`Brotes afectados (%)`, fill = PUNTO)) +
  geom_histogram(binwidth=20, position="dodge")
```

## 5. Ajuste al modelo Poisson

Se intenta ajustar los datos a un modelo con distribución Poisson, pero la distribución de estos datos no se ajustan al modelo. Se procede a realizar un test no paramétrico de Kruskal Wallis
```{r poisson_model}
#Model poisson distribution https://stats.idre.ucla.edu/r/dae/poisson-regression/----
summary(m1 <- glm(`Brotes afectados (%)` ~ MES+CULTIVAR+VARIEDAD+PORTAINJERTO+PUNTO, family="poisson", data=db_D_citri_field))
# cov.m1 <- vcovHC(m1, type="HC0")
# std.err <- sqrt(diag(cov.m1))
# r.est <- cbind(Estimate= coef(m1), "Robust SE" = std.err,
#                "Pr(>|z|)" = 2 * pnorm(abs(coef(m1)/std.err), lower.tail=FALSE),
#                LL = coef(m1) - 1.96 * std.err,
#                UL = coef(m1) + 1.96 * std.err)
# 
# r.est
```

## 6. Prueba no paramétrica
### Kruskal Wallis para el factor mes

De acuerdo con la distribución de los datos se decide dividir las observaciones en tres grupos con distribuciones similares así (el mes 4 no tiene datos):

#### group_1<- c(1:3)
compuesto por los meses 1,2 y 3
#### group_2<- c(5:6,8)
compuesto por los meses 5,6 y 8
#### group_3<- c(7,9,10:12)
compuesto por los meses7, 9, 10, 11 y 12

```{r kw_month}
#Non-parametric approach----
#Boxplot MES
ggplot(data = db_D_citri_field, mapping = aes(x = MES, y = `Brotes afectados (%)`, colour = MES)) +
  geom_boxplot() +
  theme_bw() +
  theme(legend.position = "none")
#Distribution MES
 ggplot(data = db_D_citri_field, mapping = aes(x = `Brotes afectados (%)`, colour = MES)) +
  geom_histogram() +
  theme_bw() +
  facet_grid(. ~ MES) +
  theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 45))


##Note: According to distribution plots moths months with same distribition could be:
##group_1<- c(1:3)
##group_2<- c(5:6,8)
##group_3<- c(7,9,10:12)
#KW test group_1
group_1_month<- kruskal(db_D_citri_field[db_D_citri_field$MES %in% c(1:3),]$`Brotes afectados (%)`, db_D_citri_field[db_D_citri_field$MES %in% c(1:3),]$MES,group=TRUE, p.adj = "bonferroni")
group_1_month
#KW test group_2
group_2_month<- kruskal(db_D_citri_field[db_D_citri_field$MES %in% c(5:6,8),]$`Brotes afectados (%)`, db_D_citri_field[db_D_citri_field$MES %in% c(5:6,8),]$MES,group=TRUE, p.adj = "bonferroni")
group_2_month
#KW test group_3
group_3_month<- kruskal(db_D_citri_field[db_D_citri_field$MES %in% c(7,9,10:12),]$`Brotes afectados (%)`, db_D_citri_field[db_D_citri_field$MES %in% c(7,9,10:12),]$MES,group=TRUE, p.adj = "bonferroni")
group_3_month
```

### Kruskal Wallis para el factor Cultivar

De acuerdo con la distribución de los datos se decide dividir las observaciones en 1 grupo con distribuciones similares así :

#### group_1<- c("Limón", "Mandarina", "Naranja")
compuesto por los tres cultivares

```{r kw_cultivar}
#Boxplot CULTIVAR
ggplot(data = db_D_citri_field, mapping = aes(x = CULTIVAR, y = `Brotes afectados (%)`, colour = CULTIVAR)) +
  geom_boxplot() +
  theme_bw() +
  theme(legend.position = "none")
#Distribution CULTIVAR
 ggplot(data = db_D_citri_field, mapping = aes(x = `Brotes afectados (%)`, colour = CULTIVAR)) +
  geom_histogram() +
  theme_bw() +
  facet_grid(. ~ CULTIVAR) +
  theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 45))


##Note: According to distribution plots CULTIVAR with same distribition could be: Limón, Mandarina, and Naranja
#KW test group_1
group_CULTIVAR<- kruskal(db_D_citri_field$`Brotes afectados (%)`, db_D_citri_field$CULTIVAR,group=TRUE, p.adj = "bonferroni")
group_CULTIVAR

```

### Kruskal Wallis para el factor Variedad

De acuerdo con la distribución de los datos se decide dividir las observaciones en 1 grupo con distribuciones similares así:

#### group_1<- Todas las observaciones menos la mandarina oneco
compuesto todas las variedades menos la mandarina oneco. Sin embargo, se decide adicionar la variedad oneco en el estadístico dado que de quedarse sola la variedad Oneco no se podría realizar el comparativo


```{r KW_variety}
#Boxplot VARIEDAD
ggplot(data = db_D_citri_field, mapping = aes(x = VARIEDAD, y = `Brotes afectados (%)`, colour = VARIEDAD)) +
  geom_boxplot() +
  theme_bw() +
  theme(legend.position = "none")
#Distribution VARIEDAD
 ggplot(data = db_D_citri_field, mapping = aes(x = `Brotes afectados (%)`, colour = VARIEDAD)) +
  geom_histogram() +
  theme_bw() +
  facet_grid(. ~ VARIEDAD) +
  theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 45))


##Note: According to distribution plots VARIEDAD with same distribition could be: 
#group 1: all except oneco
#group 2: oneco 
#However kw test coulb be done with all varieties
#KW test group_1
group_VARIEDAD<- kruskal(db_D_citri_field$`Brotes afectados (%)`, db_D_citri_field$VARIEDAD,group=TRUE, p.adj = "bonferroni")
group_VARIEDAD

```

### Kruskal Wallis para el factor Portainjerto

De acuerdo con la distribución de los datos se decide dividir las observaciones en 1 grupo con distribuciones similares así:

#### group_1<- CPB4475 y SxE
Se recomienda para futuros análisis usar la prueba de Wilcoxon en lugar de la Kruskal dado que solo se están comparando don niveles de un factor

```{r kw_portainjerto}
#Boxplot PORTAINJERTO
ggplot(data = db_D_citri_field, mapping = aes(x = PORTAINJERTO, y = `Brotes afectados (%)`, colour = PORTAINJERTO)) +
  geom_boxplot() +
  theme_bw() +
  theme(legend.position = "none")
#Distribution PORTAINJERTO
 ggplot(data = db_D_citri_field, mapping = aes(x = `Brotes afectados (%)`, colour = PORTAINJERTO)) +
  geom_histogram() +
  theme_bw() +
  facet_grid(. ~ PORTAINJERTO) +
  theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 45))


##Note: According to distribution plots PORTAINJERTO with same distribition could be: CPB AND SXE
#KW test group_1
group_PORTAINJERTO<- kruskal(db_D_citri_field$`Brotes afectados (%)`, db_D_citri_field$PORTAINJERTO,group=TRUE, p.adj = "bonferroni")
group_PORTAINJERTO

```

### Kruskal Wallis para el factor Punto cardinal

De acuerdo con la distribución de los datos se decide dividir las observaciones en 1 grupo con distribuciones similares así:

#### group_1<- todos los puntos cardinales
El grupo está conformado por todos los puntos cardinales

```{r kw_punto}
#Boxplot PUNTO
ggplot(data = db_D_citri_field, mapping = aes(x = PUNTO, y = `Brotes afectados (%)`, colour = PUNTO)) +
  geom_boxplot() +
  theme_bw() +
  theme(legend.position = "none")
#Distribution PUNTO
 ggplot(data = db_D_citri_field, mapping = aes(x = `Brotes afectados (%)`, colour = PUNTO)) +
  geom_histogram() +
  theme_bw() +
  facet_grid(. ~ PUNTO) +
  theme(legend.position = "none")+
  theme(axis.text.x = element_text(angle = 45))


##Note: According to distribution plots PUNTO with same distribition could be: CPB AND SXE
#KW test group_1
group_PUNTO<- kruskal(db_D_citri_field$`Brotes afectados (%)`, db_D_citri_field$PUNTO,group=TRUE, p.adj = "bonferroni")
group_PUNTO
```

#### Se adjunta los gráficos en Power Point